<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiPeople Graph</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!--  The CSS styles -->
    <style>
        body {
            font-family: "Inter", sans-serif;
            overflow: hidden; /* Hide scrollbars */
            background-color: #201515; 
        }

        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .node-circle { 
            stroke: #fff;
            stroke-width: 1.5px;
            cursor: pointer; 
        }

        .nodes-and-labels g text {
            fill: #ccc; /* Light gray text */
            font-size: 10px;
            pointer-events: none; /* Text doesn't block mouse events */
            text-anchor: middle; /* Center the text below the node */
        }

        #tooltip {
            position: absolute;
            opacity: 0;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            pointer-events: none; /* Allows mouse events to pass through */
            transition: opacity 0.2s;
            font-size: 0.875rem;
        }
    </style>
</head>
<!-- Removed Tailwind background class -->
<body class="h-full text-gray-100">

    <!-- The SVG (Scalable Vector Graphics) container -->
    <svg id="graph-viz" class="w-full h-full"></svg>

    <!-- The Tooltip element -->
    <div id="tooltip"></div>

    <!-- Loading message -->
    <div id="loading" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl">
        Loading graph-viz.json...
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        // SETUP

        const svg = d3.select("#graph-viz");
        const loadingText = d3.select("#loading");
        const width = +svg.node().getBoundingClientRect().width;
        const height = +svg.node().getBoundingClientRect().height;
        const tooltip = d3.select("#tooltip");

        // Define node colors
        const nodeColors = {
            "root": "#d8ff4d",          
            "mutual_neighbor": "#2F5249" 
        };

        // LOAD THE DATA

        d3.json("graph-viz.json").then(graph => {

            loadingText.style("display", "none");

            // THE PHYSICS SIMULATION

            const simulation = d3.forceSimulation(graph.nodes)
                .force("link", d3.forceLink(graph.links).id(d => d.id).distance(60)) // Adjusted distance
                .force("charge", d3.forceManyBody().strength(-150)) // Adjusted strength
                .force("center", d3.forceCenter(width / 2, height / 2))
                .on("tick", ticked);

            // DRAW THE SVG ELEMENTS 

            const g = svg.append("g");

            const link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(graph.links)
                .enter().append("line")
                .attr("stroke-width", 1);

            // Create groups for nodes AND labels together
            const nodeGroup = g.append("g")
                .attr("class", "nodes-and-labels") // Keep this class for the main group
                .selectAll("g") // Select groups instead of circles directly
                .data(graph.nodes)
                .enter().append("g"); // Create a <g> for each node+label

            // Draw the nodes (circles) inside the group
            const node = nodeGroup.append("circle")
                .attr("class", "node-circle") // Added class for easier selection later if needed
                .attr("r", d => d.group === 'root' ? 10 : 5) // Adjusted size
                .attr("fill", d => nodeColors[d.group] || "#ccc") // Use updated colors
                .call(drag(simulation));

            // Draw the labels (text) inside the group
            const label = nodeGroup.append("text")
                .text(d => d.id) // Display the person's name
                .attr('x', 0)     // Center text horizontally initially
                .attr('y', d => (d.group === 'root' ? 10 : 5) + 12); // Position below the circle (radius + padding)

            // INTERACTIVITY

            // Tooltips (still useful for potentially long names)
            node.on("mouseover", (event, d) => {
                tooltip.style("opacity", 1)
                       .html(d.id);
                d3.select(event.currentTarget)
                  .transition().duration(100)
                  .attr("r", d => d.group === 'root' ? 15 : 10); // Enlarge on hover
            })
            .on("mousemove", (event) => {
                tooltip.style("left", (event.pageX + 10) + "px")
                       .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", (event, d) => {
                tooltip.style("opacity", 0);
                d3.select(event.currentTarget)
                  .transition().duration(100)
                  .attr("r", d => d.group === 'root' ? 10 : 5); // Reset size
            });

            // --- ADDED FEATURE: Double-click to open Wikipedia page ---
            node.on("dblclick", (event, d) => {
                // Check if the URL exists in the data
                if (d.url) {
                    window.open(d.url, '_blank'); // Open the URL from the JSON data
                } else {
                    console.warn("Node clicked, but no URL found in data:", d);
                }
            });
            // --------------------------------------------------------

            // Zooming
            svg.call(d3.zoom()
                .extent([[0, 0], [width, height]])
                .scaleExtent([0.1, 8])
                .on("zoom", ({ transform }) => {
                    g.attr("transform", transform);
                }));

            // THE "TICK" (ANIMATION) FUNCTION

            function ticked() {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                nodeGroup // Move the <g> element containing circle and text
                    .attr("transform", d => `translate(${d.x},${d.y})`);
                // ----------------------------------------------------------
            }

            // DRAG FUNCTIONS

            function drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                return d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended);
            }

        }).catch(error => {
            console.error("Error loading graph data:", error);
            loadingText.text("Error: Could not load graph-viz.json. Did you run prepare_viz_data.py?");
        });
    </script>
</body>
</html>

